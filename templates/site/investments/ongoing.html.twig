{% extends 'base.html.twig' %}

{% block title %}Mes Investissements en cours{% endblock %}

{% block body %}
    <h1 class="text-center my-5">Mes Investissements en cours</h1>
    <div class="row g-4">
        {# La boucle utilise le tableau d'objets PHP #}
        {% for investment in investments %}
            <div class="col-md-6 col-lg-4 d-flex">
                <div class="card card-investment w-100">
                    <div class="card-header">
                        {{ investment.name }}
                    </div>
                    <div class="card-body">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Capital Initial
                                <span class="badge bg-primary rounded-pill badge-capital">{{ investment.startingCapital / 100 }} €</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Déjà Reçu
                                <span class="badge bg-success rounded-pill">{{ investment.alreadyReceived / 100 }} €</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Intérêt/Mois
                                <span class="badge bg-info rounded-pill">{{ investment.interestByMonth / 100 }} €</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Mois Restants
                                {% set remainingMonths = investment.getRemainingMonths() %}
                                {% if remainingMonths == 'Terminé' %}
                                    <span class="badge bg-danger rounded-pill">{{ remainingMonths }}</span>
                                {% else %}
                                    <span class="badge bg-secondary rounded-pill">{{ remainingMonths }} mois</span>
                                {% endif %}
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Date de Début
                                <span>{{ investment.startAt ? investment.startAt|date('d/m/Y') : 'N/A' }}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Date de Fin
                                <span>{{ investment.endAt ? investment.endAt|date('d/m/Y') : 'N/A' }}</span>
                            </li>
                        </ul>
                        {% if investment.earlyRepayments is not empty %}
                            <div class="text-center mt-3">
                                <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#earlyRepaymentModal" data-investment-id="{{ investment.id }}">
                                    Voir les remboursements anticipés ({{ investment.earlyRepayments|length }})
                                </button>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>

    {# La modale est toujours la même #}
    <div class="modal fade" id="earlyRepaymentModal" tabindex="-1" aria-labelledby="earlyRepaymentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="earlyRepaymentModalLabel">Remboursements Anticipés</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <ul class="list-group" id="repayments-list">
                        {# Le contenu sera inséré ici par le JavaScript #}
                    </ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const investments = JSON.parse('{{ investmentsJson|raw }}');
            
            const earlyRepaymentModal = document.getElementById('earlyRepaymentModal');
            
            earlyRepaymentModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget; 
                const investmentId = button.getAttribute('data-investment-id');
                const investment = investments.find(inv => inv.id == investmentId);

                const repaymentsList = document.getElementById('repayments-list');
                repaymentsList.innerHTML = '';

                if (investment && investment.earlyRepayments.length > 0) {
                    investment.earlyRepayments.forEach(repayment => {
                        const listItem = document.createElement('li');
                        listItem.className = 'list-group-item d-flex flex-column'; // Ajout de flex-column pour la mise en page

                        const formattedValue = (repayment.value / 100).toFixed(2);
                        const formattedCapital = (repayment.remainingCapital / 100).toFixed(2);
                        const formattedInterest = (repayment.remainingInterestByMonth / 100).toFixed(2);
                        const formattedDate = new Date(repayment.createdAt).toLocaleDateString('fr-FR');

                        listItem.innerHTML = `
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <span class="fw-bold fs-5">${formattedValue} €</span>
                                <span class="text-muted small">${formattedDate}</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center text-muted small">
                                <span>Capital restant : ${formattedCapital} €</span>
                                <span>Intérêt/mois : ${formattedInterest} €</span>
                            </div>
                        `;
                        repaymentsList.appendChild(listItem);
                    });
                } else {
                    repaymentsList.innerHTML = '<li class="list-group-item text-center text-muted">Aucun remboursement anticipé.</li>';
                }
            });
        });
    </script>
{% endblock %}